language: go

stages:
  - name: test
    if: branch = ci
  - name: deploy
    if: tag IS present

jobs:
  include:
    - stage: test
      script:
        - export GO111MODULE=on
        - go mod download
        - go test -v ./...
        - touch .env
        - docker-compose build
    - stage: deploy
      services:
        - docker
      script:
        - docker login --username $DOCKERHUB_USERNAME --password $DOCKERHUB_PASSWORD
        - touch .env
        - export TAG=${TRAVIS_TAG}
        - docker-compose build
        - docker-compose push
